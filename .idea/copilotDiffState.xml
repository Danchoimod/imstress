<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/java/com/poly/api/CommentApi.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/com/poly/api/CommentApi.java" />
              <option name="originalContent" value="package com.poly.api;&#10;&#10;import com.google.gson.Gson;&#10;import com.google.gson.GsonBuilder;&#10;import com.poly.entities.Comment;&#10;import com.poly.reponse.CommentResponse;&#10;import com.poly.services.CommentServices;&#10;&#10;import javax.servlet.ServletException;&#10;import javax.servlet.annotation.WebServlet;&#10;import javax.servlet.http.HttpServlet;&#10;import javax.servlet.http.HttpServletRequest;&#10;import javax.servlet.http.HttpServletResponse;&#10;import java.io.IOException;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;@WebServlet(urlPatterns = &quot;/api/comment&quot;)&#10;public class CommentApi extends HttpServlet {&#10;&#10;    // Xử lý GET: Hiển thị danh sách comment theo video ID&#10;    @Override&#10;    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {&#10;        req.setCharacterEncoding(&quot;UTF-8&quot;);&#10;        List&lt;CommentResponse&gt; responsecomment = new ArrayList&lt;&gt;();&#10;&#10;        String videoIdParam = req.getParameter(&quot;videoid&quot;); // Lấy tham số &quot;videoid&quot;&#10;        if (videoIdParam == null) {&#10;            resp.sendError(HttpServletResponse.SC_BAD_REQUEST, &quot;Missing videoid parameter&quot;);&#10;            return;&#10;        }&#10;&#10;        try {&#10;            int videoId = Integer.parseInt(videoIdParam);&#10;            resp.setContentType(&quot;application/json; charset=UTF-8&quot;);&#10;&#10;            List&lt;Comment&gt; comments = CommentServices.getCommentbyID(videoId);&#10;            for (Comment entity : comments) {&#10;                CommentResponse response = new CommentResponse();&#10;                response.setId(entity.getId());&#10;                response.setContent(entity.getContent());&#10;                response.setStatus(entity.isStatus());&#10;&#10;                // ✅ THAY ĐỔI: Ánh xạ User Name thành USERNAME (Tên hiển thị)&#10;                response.setUserName(entity.getUser() != null ? entity.getUser().getUsername() : &quot;Anonymous&quot;);&#10;                response.setUserId(entity.getUser() != null ? entity.getUser().getId() : null);&#10;&#10;                // Ánh xạ Parent ID&#10;                response.setParentCommentId(entity.getComment() != null ? entity.getComment().getId() : null);&#10;&#10;                // Bỏ qua createAt&#10;&#10;                responsecomment.add(response);&#10;            }&#10;&#10;            Gson gson = new GsonBuilder().serializeNulls().create(); // Tạo Gson&#10;            resp.getWriter().println(gson.toJson(responsecomment)); // Trả về JSON&#10;&#10;        } catch (NumberFormatException e) {&#10;            resp.sendError(HttpServletResponse.SC_BAD_REQUEST, &quot;Invalid videoid format&quot;);&#10;        } catch (Exception e) {&#10;            e.printStackTrace();&#10;            resp.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, &quot;An error occurred while fetching comments.&quot;);&#10;        }&#10;    }&#10;&#10;    // THÊM: Xử lý POST: Thêm comment mới&#10;    @Override&#10;    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {&#10;        req.setCharacterEncoding(&quot;UTF-8&quot;);&#10;        resp.setContentType(&quot;application/json; charset=UTF-8&quot;);&#10;        Gson gson = new Gson();&#10;&#10;        try {&#10;            // Đọc dữ liệu JSON (content, video_id, user_id) từ body&#10;            Comment newComment = gson.fromJson(req.getReader(), Comment.class);&#10;&#10;            // Kiểm tra các trường bắt buộc&#10;            if (newComment == null || newComment.getContent() == null || newComment.getVideo() == null || newComment.getUser() == null) {&#10;                resp.sendError(HttpServletResponse.SC_BAD_REQUEST, &quot;Missing required fields (content, videoId, userId)&quot;);&#10;                return;&#10;            }&#10;&#10;            // Thực hiện lưu comment&#10;            Comment savedComment = CommentServices.insertComment(newComment);&#10;&#10;            if (savedComment != null) {&#10;                resp.setStatus(HttpServletResponse.SC_CREATED);&#10;                // Trả về response của comment vừa tạo&#10;                resp.getWriter().println(gson.toJson(savedComment));&#10;            } else {&#10;                resp.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, &quot;Failed to save comment.&quot;);&#10;            }&#10;&#10;        } catch (Exception e) {&#10;            e.printStackTrace();&#10;            resp.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, &quot;Error adding comment: &quot; + e.getMessage());&#10;        }&#10;    }&#10;&#10;    @Override&#10;    protected void doDelete(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {&#10;        req.setCharacterEncoding(&quot;UTF-8&quot;);&#10;        String commentIdParam = req.getParameter(&quot;id&quot;);&#10;        if (commentIdParam == null) {&#10;            resp.sendError(HttpServletResponse.SC_BAD_REQUEST, &quot;Missing id parameter&quot;);&#10;            return;&#10;        }&#10;&#10;        try {&#10;            int commentId = Integer.parseInt(commentIdParam);&#10;            Integer currentUserId = CommentServices.getCurrentUserId(req);&#10;            if (currentUserId == null) {&#10;                resp.sendError(HttpServletResponse.SC_UNAUTHORIZED, &quot;User not authenticated&quot;);&#10;                return;&#10;            }&#10;&#10;            Comment target = CommentServices.findById(commentId);&#10;            if (target == null) {&#10;                resp.sendError(HttpServletResponse.SC_NOT_FOUND, &quot;Comment not found&quot;);&#10;                return;&#10;            }&#10;&#10;            if (target.getUser() == null || target.getUser().getId() != currentUserId) {&#10;                resp.sendError(HttpServletResponse.SC_FORBIDDEN, &quot;You cannot delete this comment&quot;);&#10;                return;&#10;            }&#10;&#10;            boolean deleted = CommentServices.deleteComment(commentId);&#10;            if (deleted) {&#10;                resp.setStatus(HttpServletResponse.SC_NO_CONTENT);&#10;            } else {&#10;                resp.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, &quot;Failed to delete comment&quot;);&#10;            }&#10;        } catch (NumberFormatException e) {&#10;            resp.sendError(HttpServletResponse.SC_BAD_REQUEST, &quot;Invalid id format&quot;);&#10;        }&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.poly.api;&#10;&#10;import com.google.gson.Gson;&#10;import com.google.gson.GsonBuilder;&#10;import com.poly.entities.Comment;&#10;import com.poly.reponse.CommentResponse;&#10;import com.poly.services.CommentServices;&#10;&#10;import javax.servlet.ServletException;&#10;import javax.servlet.annotation.WebServlet;&#10;import javax.servlet.http.HttpServlet;&#10;import javax.servlet.http.HttpServletRequest;&#10;import javax.servlet.http.HttpServletResponse;&#10;import java.io.IOException;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;@WebServlet(urlPatterns = {&quot;/api/comment&quot;, &quot;/api/comment/*&quot;})&#10;public class CommentApi extends HttpServlet {&#10;&#10;    // Xử lý GET: Hiển thị danh sách comment theo video ID&#10;    @Override&#10;    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {&#10;        req.setCharacterEncoding(&quot;UTF-8&quot;);&#10;        List&lt;CommentResponse&gt; responsecomment = new ArrayList&lt;&gt;();&#10;&#10;        String videoIdParam = req.getParameter(&quot;videoid&quot;); // Lấy tham số &quot;videoid&quot;&#10;        if (videoIdParam == null) {&#10;            resp.sendError(HttpServletResponse.SC_BAD_REQUEST, &quot;Missing videoid parameter&quot;);&#10;            return;&#10;        }&#10;&#10;        try {&#10;            int videoId = Integer.parseInt(videoIdParam);&#10;            resp.setContentType(&quot;application/json; charset=UTF-8&quot;);&#10;&#10;            List&lt;Comment&gt; comments = CommentServices.getCommentbyID(videoId);&#10;            for (Comment entity : comments) {&#10;                CommentResponse response = new CommentResponse();&#10;                response.setId(entity.getId());&#10;                response.setContent(entity.getContent());&#10;                response.setStatus(entity.isStatus());&#10;&#10;                // ✅ THAY ĐỔI: Ánh xạ User Name thành USERNAME (Tên hiển thị)&#10;                response.setUserName(entity.getUser() != null ? entity.getUser().getUsername() : &quot;Anonymous&quot;);&#10;                response.setUserId(entity.getUser() != null ? entity.getUser().getId() : null);&#10;&#10;                // Ánh xạ Parent ID&#10;                response.setParentCommentId(entity.getComment() != null ? entity.getComment().getId() : null);&#10;&#10;                // Bỏ qua createAt&#10;&#10;                responsecomment.add(response);&#10;            }&#10;&#10;            Gson gson = new GsonBuilder().serializeNulls().create(); // Tạo Gson&#10;            resp.getWriter().println(gson.toJson(responsecomment)); // Trả về JSON&#10;&#10;        } catch (NumberFormatException e) {&#10;            resp.sendError(HttpServletResponse.SC_BAD_REQUEST, &quot;Invalid videoid format&quot;);&#10;        } catch (Exception e) {&#10;            e.printStackTrace();&#10;            resp.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, &quot;An error occurred while fetching comments.&quot;);&#10;        }&#10;    }&#10;&#10;    // THÊM: Xử lý POST: Thêm comment mới&#10;    @Override&#10;    protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {&#10;        req.setCharacterEncoding(&quot;UTF-8&quot;);&#10;        resp.setContentType(&quot;application/json; charset=UTF-8&quot;);&#10;        Gson gson = new Gson();&#10;&#10;        try {&#10;            // Đọc dữ liệu JSON (content, video_id, user_id) từ body&#10;            Comment newComment = gson.fromJson(req.getReader(), Comment.class);&#10;&#10;            // Kiểm tra các trường bắt buộc&#10;            if (newComment == null || newComment.getContent() == null || newComment.getVideo() == null || newComment.getUser() == null) {&#10;                resp.sendError(HttpServletResponse.SC_BAD_REQUEST, &quot;Missing required fields (content, videoId, userId)&quot;);&#10;                return;&#10;            }&#10;&#10;            // Thực hiện lưu comment&#10;            Comment savedComment = CommentServices.insertComment(newComment);&#10;&#10;            if (savedComment != null) {&#10;                resp.setStatus(HttpServletResponse.SC_CREATED);&#10;                // Trả về response của comment vừa tạo&#10;                resp.getWriter().println(gson.toJson(savedComment));&#10;            } else {&#10;                resp.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, &quot;Failed to save comment.&quot;);&#10;            }&#10;&#10;        } catch (Exception e) {&#10;            e.printStackTrace();&#10;            resp.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, &quot;Error adding comment: &quot; + e.getMessage());&#10;        }&#10;    }&#10;&#10;    private Integer extractCommentId(HttpServletRequest req) {&#10;        String idParam = req.getParameter(&quot;id&quot;);&#10;        if (idParam != null &amp;&amp; !idParam.isBlank()) {&#10;            try {&#10;                return Integer.parseInt(idParam);&#10;            } catch (NumberFormatException ignored) {&#10;                return null;&#10;            }&#10;        }&#10;        String pathInfo = req.getPathInfo();&#10;        if (pathInfo != null &amp;&amp; pathInfo.length() &gt; 1) {&#10;            String candidate = pathInfo.substring(1);&#10;            try {&#10;                return Integer.parseInt(candidate);&#10;            } catch (NumberFormatException ignored) {&#10;                return null;&#10;            }&#10;        }&#10;        return null;&#10;    }&#10;&#10;    @Override&#10;    protected void doDelete(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {&#10;        req.setCharacterEncoding(&quot;UTF-8&quot;);&#10;        Integer commentId = extractCommentId(req);&#10;        if (commentId == null) {&#10;            resp.sendError(HttpServletResponse.SC_BAD_REQUEST, &quot;Missing or invalid id&quot;);&#10;            return;&#10;        }&#10;&#10;        try {&#10;            Integer currentUserId = CommentServices.getCurrentUserId(req);&#10;            if (currentUserId == null) {&#10;                resp.sendError(HttpServletResponse.SC_UNAUTHORIZED, &quot;User not authenticated&quot;);&#10;                return;&#10;            }&#10;&#10;            Comment target = CommentServices.findById(commentId);&#10;            if (target == null) {&#10;                resp.sendError(HttpServletResponse.SC_NOT_FOUND, &quot;Comment not found&quot;);&#10;                return;&#10;            }&#10;&#10;            if (target.getUser() == null || target.getUser().getId() != currentUserId) {&#10;                resp.sendError(HttpServletResponse.SC_FORBIDDEN, &quot;You cannot delete this comment&quot;);&#10;                return;&#10;            }&#10;&#10;            boolean deleted = CommentServices.deleteComment(commentId);&#10;            if (deleted) {&#10;                resp.setStatus(HttpServletResponse.SC_NO_CONTENT);&#10;            } else {&#10;                resp.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, &quot;Failed to delete comment&quot;);&#10;            }&#10;        } catch (NumberFormatException e) {&#10;            resp.sendError(HttpServletResponse.SC_BAD_REQUEST, &quot;Invalid id format&quot;);&#10;        }&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/src/main/java/com/poly/util/Utils.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/com/poly/util/Utils.java" />
              <option name="originalContent" value="package com.poly.util;&#10;&#10;import javax.servlet.http.Cookie;&#10;import javax.servlet.http.HttpServletRequest;&#10;import javax.servlet.http.HttpServletResponse;&#10;&#10;public class Utils {&#10;//&#9;2  hằng số giữ giá trị key của cookie&#10;&#10;&#9;public static final String COOKIE_KEY_USER_ID = &quot;user_id&quot;;&#10;&#9;public static final String COOKIE_KEY_ROLE = &quot;role&quot;;&#10;&#10;&#9;public static String getCookieValue(String key, HttpServletRequest request) {&#10;&#9;&#9;Cookie[] cookies = request.getCookies();&#10;&#9;&#9;if (cookies == null) {&#10;&#9;&#9;&#9;return null;&#10;&#9;&#9;}&#10;&#9;&#9;for (Cookie cookie : cookies) {&#10;&#9;&#9;&#9;if (cookie.getName().equals(key)) {&#10;&#9;&#9;&#9;&#9;return cookie.getValue();&#10;&#9;&#9;&#9;}&#10;&#9;&#9;}&#10;&#9;&#9;return null;&#10;&#9;}&#10;&#10;&#9;public static void clearCookie(HttpServletRequest request, HttpServletResponse response) {&#10;&#9;&#9;Cookie[] cookies = request.getCookies();&#10;&#9;&#9;if (cookies == null) {&#10;&#9;&#9;&#9;return;&#10;&#9;&#9;}&#10;&#10;&#9;&#9;for (Cookie cookie : cookies) {&#10;&#9;&#9;&#9;cookie.setMaxAge(0); // Set to 0 to delete cookie&#10;&#9;&#9;&#9;cookie.setPath(&quot;/&quot;); // Must set same path as when creating cookie&#10;&#9;&#9;&#9;cookie.setValue(&quot;&quot;); // Clear value&#10;&#9;&#9;&#9;response.addCookie(cookie);&#10;&#9;&#9;}&#10;&#9;}&#10;&#10;&#9;public static void setCookie(String key, String value, HttpServletResponse response) {&#10;&#9;&#9;int day = 60 * 60 * 24 * 7;&#10;&#10;&#9;&#9;Cookie cookie = new Cookie(key, value);&#10;&#9;&#9;cookie.setMaxAge(day);&#10;&#9;&#9;cookie.setPath(&quot;/&quot;);&#10;&#9;&#9;response.addCookie(cookie);&#10;&#9;}&#10;&#10;//&#9;Phương thức INPUT: String =&gt; OUTPUT:String&#10;&#10;&#9;public static String capitalizeString(String str) {&#10;&#9;&#9;String temp = str.trim();&#10;&#10;//&#9;&#9;name = &quot;[tHế, giới, ĐỘNg, VậT]&quot;&#10;&#10;&#9;&#9;String words[] = str.trim().split(&quot;//s+&quot;);&#10;&#9;&#9;for (int i = 0; i &lt; words.length; i++) {&#10;&#9;&#9;&#9;words[i] = words[i].toLowerCase();&#10;&#9;&#9;&#9;String firstChar = words[i].substring(0, 1);&#10;&#9;&#9;&#9;firstChar = firstChar.toUpperCase();&#10;&#9;&#9;&#9;words[i] = firstChar + words[i].substring(1);&#10;&#9;&#9;}&#10;&#10;&#9;&#9;return String.join(&quot; &quot;, words);&#10;&#9;}&#10;}" />
              <option name="updatedContent" value="package com.poly.util;&#10;&#10;import javax.servlet.http.Cookie;&#10;import javax.servlet.http.HttpServletRequest;&#10;import javax.servlet.http.HttpServletResponse;&#10;&#10;public class Utils {&#10;//&#9;2  hằng số giữ giá trị key của cookie&#10;&#10;&#9;public static final String COOKIE_KEY_USER_ID = &quot;user_id&quot;;&#10;&#9;public static final String COOKIE_KEY_ROLE = &quot;role&quot;;&#10;&#10;&#9;public static String getCookieValue(String key, HttpServletRequest request) {&#10;&#9;&#9;Cookie[] cookies = request.getCookies();&#10;&#9;&#9;if (cookies == null) {&#10;&#9;&#9;&#9;return null;&#10;&#9;&#9;}&#10;&#9;&#9;for (Cookie cookie : cookies) {&#10;&#9;&#9;&#9;if (cookie.getName().equals(key)) {&#10;&#9;&#9;&#9;&#9;return cookie.getValue();&#10;&#9;&#9;&#9;}&#10;&#9;&#9;}&#10;&#9;&#9;return null;&#10;&#9;}&#10;&#10;&#9;public static void clearCookie(HttpServletRequest request, HttpServletResponse response) {&#10;&#9;&#9;Cookie[] cookies = request.getCookies();&#10;&#9;&#9;if (cookies == null) {&#10;&#9;&#9;&#9;return;&#10;&#9;&#9;}&#10;&#10;&#9;&#9;for (Cookie cookie : cookies) {&#10;&#9;&#9;&#9;cookie.setMaxAge(0); // Set to 0 to delete cookie&#10;&#9;&#9;&#9;cookie.setPath(&quot;/&quot;); // Must set same path as when creating cookie&#10;&#9;&#9;&#9;cookie.setValue(&quot;&quot;); // Clear value&#10;&#9;&#9;&#9;response.addCookie(cookie);&#10;&#9;&#9;}&#10;&#9;}&#10;&#10;&#9;public static void setCookie(String key, String value, HttpServletResponse response) {&#10;&#9;&#9;int day = 60 * 60 * 24 * 7;&#10;&#10;&#9;&#9;Cookie cookie = new Cookie(key, value);&#10;&#9;&#9;cookie.setMaxAge(day);&#10;&#9;&#9;cookie.setPath(&quot;/&quot;);&#10;&#9;&#9;response.addCookie(cookie);&#10;&#9;}&#10;&#10;//&#9;Phương thức INPUT: String =&gt; OUTPUT:String&#10;&#10;&#9;public static String capitalizeString(String str) {&#10;&#9;&#9;String temp = str.trim();&#10;&#10;//&#9;&#9;name = &quot;[tHế, giới, ĐỘNg, VậT]&quot;&#10;&#10;&#9;&#9;String words[] = str.trim().split(&quot;//s+&quot;);&#10;&#9;&#9;for (int i = 0; i &lt; words.length; i++) {&#10;&#9;&#9;&#9;words[i] = words[i].toLowerCase();&#10;&#9;&#9;&#9;String firstChar = words[i].substring(0, 1);&#10;&#9;&#9;&#9;firstChar = firstChar.toUpperCase();&#10;&#9;&#9;&#9;words[i] = firstChar + words[i].substring(1);&#10;&#9;&#9;}&#10;&#10;&#9;&#9;return String.join(&quot; &quot;, words);&#10;&#9;}&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>