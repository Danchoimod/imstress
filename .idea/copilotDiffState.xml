<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/java/com/poly/util/Utils.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/com/poly/util/Utils.java" />
              <option name="originalContent" value="package com.poly.util;&#10;&#10;import javax.servlet.http.Cookie;&#10;import javax.servlet.http.HttpServletRequest;&#10;import javax.servlet.http.HttpServletResponse;&#10;&#10;public class Utils {&#10;//&#9;2  hằng số giữ giá trị key của cookie&#10;&#10;&#9;public static final String COOKIE_KEY_USER_ID = &quot;user_id&quot;;&#10;&#9;public static final String COOKIE_KEY_ROLE = &quot;role&quot;;&#10;&#10;&#9;public static String getCookieValue(String key, HttpServletRequest request) {&#10;&#9;&#9;Cookie[] cookies = request.getCookies();&#10;&#9;&#9;if (cookies == null) {&#10;&#9;&#9;&#9;return null;&#10;&#9;&#9;}&#10;&#9;&#9;for (Cookie cookie : cookies) {&#10;&#9;&#9;&#9;if (cookie.getName().equals(key)) {&#10;&#9;&#9;&#9;&#9;return cookie.getValue();&#10;&#9;&#9;&#9;}&#10;&#9;&#9;}&#10;&#9;&#9;return null;&#10;&#9;}&#10;&#10;&#9;public static void clearCookie(HttpServletRequest request, HttpServletResponse response) {&#10;&#9;&#9;Cookie[] cookies = request.getCookies();&#10;&#9;&#9;if (cookies == null) {&#10;&#9;&#9;&#9;return;&#10;&#9;&#9;}&#10;&#10;&#9;&#9;for (Cookie cookie : cookies) {&#10;&#9;&#9;&#9;cookie.setMaxAge(0); // Set to 0 to delete cookie&#10;&#9;&#9;&#9;cookie.setPath(&quot;/&quot;); // Must set same path as when creating cookie&#10;&#9;&#9;&#9;cookie.setValue(&quot;&quot;); // Clear value&#10;&#9;&#9;&#9;response.addCookie(cookie);&#10;&#9;&#9;}&#10;&#9;}&#10;&#10;&#9;public static void setCookie(String key, String value, HttpServletResponse response) {&#10;&#9;&#9;int day = 60 * 60 * 24 * 7;&#10;&#10;&#9;&#9;Cookie cookie = new Cookie(key, value);&#10;&#9;&#9;cookie.setMaxAge(day);&#10;&#9;&#9;cookie.setPath(&quot;/&quot;);&#10;&#9;&#9;response.addCookie(cookie);&#10;&#9;}&#10;&#10;//&#9;Phương thức INPUT: String =&gt; OUTPUT:String&#10;&#10;&#9;public static String capitalizeString(String str) {&#10;&#9;&#9;String temp = str.trim();&#10;&#10;//&#9;&#9;name = &quot;[tHế, giới, ĐỘNg, VậT]&quot;&#10;&#10;&#9;&#9;String words[] = str.trim().split(&quot;//s+&quot;);&#10;&#9;&#9;for (int i = 0; i &lt; words.length; i++) {&#10;&#9;&#9;&#9;words[i] = words[i].toLowerCase();&#10;&#9;&#9;&#9;String firstChar = words[i].substring(0, 1);&#10;&#9;&#9;&#9;firstChar = firstChar.toUpperCase();&#10;&#9;&#9;&#9;words[i] = firstChar + words[i].substring(1);&#10;&#9;&#9;}&#10;&#10;&#9;&#9;return String.join(&quot; &quot;, words);&#10;&#9;}&#10;}" />
              <option name="updatedContent" value="package com.poly.util;&#10;&#10;import javax.servlet.http.Cookie;&#10;import javax.servlet.http.HttpServletRequest;&#10;import javax.servlet.http.HttpServletResponse;&#10;&#10;public class Utils {&#10;//&#9;2  hằng số giữ giá trị key của cookie&#10;&#10;&#9;public static final String COOKIE_KEY_USER_ID = &quot;user_id&quot;;&#10;&#9;public static final String COOKIE_KEY_ROLE = &quot;role&quot;;&#10;&#10;&#9;public static String getCookieValue(String key, HttpServletRequest request) {&#10;&#9;&#9;Cookie[] cookies = request.getCookies();&#10;&#9;&#9;if (cookies == null) {&#10;&#9;&#9;&#9;return null;&#10;&#9;&#9;}&#10;&#9;&#9;for (Cookie cookie : cookies) {&#10;&#9;&#9;&#9;if (cookie.getName().equals(key)) {&#10;&#9;&#9;&#9;&#9;return cookie.getValue();&#10;&#9;&#9;&#9;}&#10;&#9;&#9;}&#10;&#9;&#9;return null;&#10;&#9;}&#10;&#10;&#9;public static void clearCookie(HttpServletRequest request, HttpServletResponse response) {&#10;&#9;&#9;Cookie[] cookies = request.getCookies();&#10;&#9;&#9;if (cookies == null) {&#10;&#9;&#9;&#9;return;&#10;&#9;&#9;}&#10;&#10;&#9;&#9;for (Cookie cookie : cookies) {&#10;&#9;&#9;&#9;cookie.setMaxAge(0); // Set to 0 to delete cookie&#10;&#9;&#9;&#9;cookie.setPath(&quot;/&quot;); // Must set same path as when creating cookie&#10;&#9;&#9;&#9;cookie.setValue(&quot;&quot;); // Clear value&#10;&#9;&#9;&#9;response.addCookie(cookie);&#10;&#9;&#9;}&#10;&#9;}&#10;&#10;&#9;public static void setCookie(String key, String value, HttpServletResponse response) {&#10;&#9;&#9;int day = 60 * 60 * 24 * 7;&#10;&#10;&#9;&#9;Cookie cookie = new Cookie(key, value);&#10;&#9;&#9;cookie.setMaxAge(day);&#10;&#9;&#9;cookie.setPath(&quot;/&quot;);&#10;&#9;&#9;response.addCookie(cookie);&#10;&#9;}&#10;&#10;//&#9;Phương thức INPUT: String =&gt; OUTPUT:String&#10;&#10;&#9;public static String capitalizeString(String str) {&#10;&#9;&#9;String temp = str.trim();&#10;&#10;//&#9;&#9;name = &quot;[tHế, giới, ĐỘNg, VậT]&quot;&#10;&#10;&#9;&#9;String words[] = str.trim().split(&quot;//s+&quot;);&#10;&#9;&#9;for (int i = 0; i &lt; words.length; i++) {&#10;&#9;&#9;&#9;words[i] = words[i].toLowerCase();&#10;&#9;&#9;&#9;String firstChar = words[i].substring(0, 1);&#10;&#9;&#9;&#9;firstChar = firstChar.toUpperCase();&#10;&#9;&#9;&#9;words[i] = firstChar + words[i].substring(1);&#10;&#9;&#9;}&#10;&#10;&#9;&#9;return String.join(&quot; &quot;, words);&#10;&#9;}&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/src/main/webapp/views/user/watch.jsp">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/webapp/views/user/watch.jsp" />
              <option name="originalContent" value="&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&#10;&lt;!DOCTYPE html&gt;&#10;&lt;html lang=&quot;vi&quot;&gt;&#10;&lt;head&gt;&#10;    &lt;meta charset=&quot;UTF-8&quot;&gt;&#10;    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;&#10;    &lt;title&gt;Xem phim - RoPhim&lt;/title&gt;&#10;    &lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;&#10;    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css&quot;&gt;&#10;    &lt;style&gt;&#10;        :root {&#10;            --primary-color: #e50914;&#10;            --dark-color: #141414;&#10;            --light-color: #f4f4f4;&#10;            --secondary-color: #2c2c2c;&#10;        }&#10;&#10;        body {&#10;            background-color: #191b24;&#10;            color: var(--light-color);&#10;            font-family: 'Helvetica Neue', Arial, sans-serif;&#10;        }&#10;&#10;        .watch-container {&#10;            max-width: 1200px;&#10;            margin: 4rem auto;&#10;            padding: 0 15px;&#10;        }&#10;&#10;        .video-section {&#10;            background-color: var(--secondary-color);&#10;            border-radius: 10px;&#10;            padding: 1.5rem;&#10;            margin-bottom: 2rem;&#10;        }&#10;&#10;        .video-player {&#10;            /* Giữ nguyên chiều rộng và chiều cao để iframe lấp đầy */&#10;            width: 100%;&#10;            height: 500px;&#10;            background-color: #000;&#10;            border-radius: 8px;&#10;            margin-bottom: 1rem;&#10;            position: relative;&#10;            overflow: hidden;&#10;        }&#10;&#10;        /* Đảm bảo iframe lấp đầy hoàn toàn div chứa nó */&#10;        .video-player iframe {&#10;            width: 100%;&#10;            height: 100%;&#10;            border: none;&#10;        }&#10;&#10;        /* Loại bỏ CSS cho placeholder vì ta chèn iframe tĩnh */&#10;        .video-placeholder {&#10;            display: none;&#10;            /* Ẩn placeholder */&#10;        }&#10;&#10;        .video-info {&#10;            background-color: var(--secondary-color);&#10;            border-radius: 10px;&#10;            padding: 1.5rem;&#10;            margin-bottom: 2rem;&#10;        }&#10;&#10;        .video-title {&#10;            font-size: 1.5rem;&#10;            margin-bottom: 1rem;&#10;            color: var(--light-color);&#10;        }&#10;&#10;        .video-meta {&#10;            display: flex;&#10;            gap: 20px;&#10;            margin-bottom: 1rem;&#10;            color: #aaa;&#10;            font-size: 0.9rem;&#10;        }&#10;&#10;        .video-description {&#10;            line-height: 1.6;&#10;            color: #ccc;&#10;            margin-top: 1rem;&#10;        }&#10;&#10;        .section-title {&#10;            border-left: 4px solid var(--primary-color);&#10;            padding-left: 10px;&#10;            margin-bottom: 1.5rem;&#10;            font-weight: bold;&#10;        }&#10;&#10;        .comment-section {&#10;            background-color: var(--secondary-color);&#10;            border-radius: 10px;&#10;            padding: 1.5rem;&#10;        }&#10;&#10;        /* Style cho Form Gửi Comment */&#10;        .comment-form .btn-primary {&#10;            background-color: var(--primary-color);&#10;            border-color: var(--primary-color);&#10;            transition: background-color 0.3s;&#10;        }&#10;        .comment-form .btn-primary:hover {&#10;            background-color: #ff3333;&#10;            border-color: #ff3333;&#10;        }&#10;&#10;        .comment-item {&#10;            background-color: #333;&#10;            border-radius: 10px;&#10;            padding: 1rem;&#10;            margin-bottom: 1rem;&#10;        }&#10;&#10;        .comment-header {&#10;            display: flex;&#10;            justify-content: space-between;&#10;            margin-bottom: 0.5rem;&#10;            gap: 1rem;&#10;        }&#10;&#10;        .comment-time-actions {&#10;            display: flex;&#10;            align-items: center;&#10;            gap: 0.75rem;&#10;        }&#10;&#10;        .comment-delete-btn {&#10;            background: transparent;&#10;            border: none;&#10;            color: #ff6b6b;&#10;            cursor: pointer;&#10;            font-size: 0.85rem;&#10;            padding: 0.2rem 0.4rem;&#10;            transition: color 0.2s;&#10;        }&#10;&#10;        .comment-delete-btn:hover {&#10;            color: #ff8a8a;&#10;            text-decoration: underline;&#10;        }&#10;&#10;        .comment-author {&#10;            color: var(--primary-color);&#10;            font-weight: bold;&#10;        }&#10;&#10;        .comment-time {&#10;            color: #aaa;&#10;            font-size: 0.9rem;&#10;        }&#10;&#10;        .comment-content {&#10;            line-height: 1.5;&#10;        }&#10;&#10;        .load-more {&#10;            text-align: center;&#10;            margin-top: 1rem;&#10;        }&#10;&#10;        .btn-load-more {&#10;            background-color: #333;&#10;            color: var(--light-color);&#10;            border: none;&#10;            padding: 10px 20px;&#10;            border-radius: 5px;&#10;            transition: all 0.3s;&#10;        }&#10;&#10;        .btn-load-more:hover {&#10;            background-color: var(--primary-color);&#10;        }&#10;&#10;        .login-prompt {&#10;            text-align: center;&#10;            padding: 2rem;&#10;            color: #aaa;&#10;        }&#10;&#10;        .login-prompt a {&#10;            color: var(--primary-color);&#10;            text-decoration: none;&#10;        }&#10;&#10;        .login-prompt a:hover {&#10;            text-decoration: underline;&#10;        }&#10;&#10;        @media (max-width: 768px) {&#10;            .video-player {&#10;                height: 300px;&#10;            }&#10;            .video-controls {&#10;                flex-direction: column;&#10;                gap: 10px;&#10;            }&#10;        }&#10;    &lt;/style&gt;&#10;&lt;/head&gt;&#10;&lt;body style=&quot;margin-top:100px;&quot;&gt;&#10;    &lt;%@ include file=&quot;../component/common/Header.jsp&quot;%&gt;&#10;&#10;    &lt;div class=&quot;watch-container&quot;&gt;&#10;        &lt;div class=&quot;video-section&quot;&gt;&#10;            &lt;div class=&quot;video-player&quot; id=&quot;video-container&quot;&gt;&#10;                &lt;iframe id=&quot;video-frame&quot;&#10;                    width=&quot;100%&quot;&#10;                    height=&quot;100%&quot;&#10;                    src=&quot;&quot;&#10;                    title=&quot;Video player&quot;&#10;                    frameborder=&quot;0&quot;&#10;                    allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot;&#10;                    allowfullscreen&gt;&#10;                &lt;/iframe&gt;&#10;            &lt;/div&gt;&#10;            &lt;div class=&quot;video-info&quot;&gt;&#10;                &lt;h1 class=&quot;video-title&quot; id=&quot;video-title&quot;&gt;title&lt;/h1&gt;&#10;                &lt;div class=&quot;video-meta&quot;&gt;&#10;                    &lt;span id=&quot;video-date&quot;&gt;loading...&lt;/span&gt;&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;video-description&quot; id=&quot;video-description&quot;&gt;&#10;                    description&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;&#10;            &lt;div class=&quot;comment-section&quot;&gt;&#10;                &lt;h3 class=&quot;section-title&quot;&gt;Bình luận (&lt;span id=&quot;comment-count&quot;&gt;0&lt;/span&gt;)&lt;/h3&gt;&#10;&#10;                &lt;div class=&quot;comment-form mb-4&quot; id=&quot;comment-form-section&quot; style=&quot;display: none;&quot;&gt;&#10;                    &lt;textarea class=&quot;form-control&quot; id=&quot;comment-input&quot; rows=&quot;3&quot; placeholder=&quot;Nhập bình luận của bạn...&quot; style=&quot;background-color: #444; color: #fff; border: 1px solid #555;&quot; required&gt;&lt;/textarea&gt;&#10;                    &lt;div class=&quot;d-flex justify-content-end mt-2&quot;&gt;&#10;                        &lt;button class=&quot;btn btn-primary&quot; id=&quot;post-comment-btn&quot;&gt;Gửi bình luận&lt;/button&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div class=&quot;login-prompt&quot; id=&quot;login-prompt-section&quot; style=&quot;display: none;&quot;&gt;&#10;                    &lt;a href=&quot;${pageContext.request.contextPath}/auth/login&quot;&gt;Đăng nhập để bình luận&lt;/a&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div id=&quot;comments-list&quot;&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div class=&quot;load-more&quot;&gt;&#10;                    &lt;button class=&quot;btn-load-more&quot;&gt;&#10;                        &lt;i class=&quot;bi bi-arrow-down me-2&quot;&gt;&lt;/i&gt;Tải thêm bình luận&#10;                    &lt;/button&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;    &lt;/div&gt;&#10;&#10;    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js&quot;&gt;&lt;/script&gt;&#10;    &lt;script&gt;&#10;    const VIDEO_API_URL = &quot;${pageContext.request.contextPath}/api/videos&quot;;&#10;    const COMMENT_API_URL = &quot;${pageContext.request.contextPath}/api/comment&quot;;&#10;    const USER_INFO_API_URL = &quot;${pageContext.request.contextPath}/api/userinfo&quot;;&#10;&#10;    const iframe = document.getElementById(&quot;video-frame&quot;);&#10;&#10;    let LOGGED_IN_USER_ID = null;&#10;    let LOGGED_IN_USER_DISPLAY_NAME = 'Anonymous';&#10;&#10;    // ✅ CẬP NHẬT: Hàm tải thông tin người dùng và hiển thị form comment&#10;    async function fetchUserInfo() {&#10;        try {&#10;            const response = await fetch(USER_INFO_API_URL);&#10;            if (!response.ok) {&#10;                // User chưa đăng nhập hoặc API lỗi&#10;                document.getElementById('login-prompt-section').style.display = 'block';&#10;                return;&#10;            }&#10;&#10;            const user = await response.json();&#10;&#10;            if (user.id) {&#10;                LOGGED_IN_USER_ID = user.id;&#10;            }&#10;&#10;            // ✅ CẬP NHẬT: Sử dụng username làm tên hiển thị&#10;            if (user.username) {&#10;                LOGGED_IN_USER_DISPLAY_NAME = user.username;&#10;            } else if (user.name) {&#10;                // Fallback nếu username không tồn tại&#10;                LOGGED_IN_USER_DISPLAY_NAME = user.name;&#10;            }&#10;&#10;            // Hiển thị form comment&#10;            document.getElementById('comment-form-section').style.display = 'block';&#10;            const commentInput = document.getElementById('comment-input');&#10;            if (commentInput) {&#10;                commentInput.placeholder = `Bình luận với tên ${LOGGED_IN_USER_DISPLAY_NAME}...`;&#10;            }&#10;&#10;        } catch (error) {&#10;            console.error(&quot;Lỗi khi tải dữ liệu người dùng:&quot;, error);&#10;            document.getElementById('login-prompt-section').style.display = 'block';&#10;        }&#10;    }&#10;&#10;    //lấy id của video&#10;    function getYouTubeId(url) {&#10;        if (!url) return null;&#10;        url = url.trim().replace(/&quot;/g, '');&#10;&#10;        const patterns = [&#10;            /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,&#10;            /youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/,&#10;            /youtu\.be\/([a-zA-Z0-9_-]{11})/,&#10;            /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,&#10;            /youtube\.com\/v\/([a-zA-Z0-9_-]{11})/&#10;        ];&#10;&#10;        for (let pattern of patterns) {&#10;            const match = url.match(pattern);&#10;            if (match &amp;&amp; match[1]) {&#10;                return match[1];&#10;            }&#10;        }&#10;        return null;&#10;    }&#10;&#10;    // ✅ CẬP NHẬT: Hàm render một comment (Sử dụng comment.userId)&#10;    function renderComment(comment) {&#10;        const userName = comment.userName || 'Anonymous';&#10;        const content = comment.content || 'Không có nội dung.';&#10;        const timeAgo = &quot;Vừa xong&quot;; // Cần logic tính thời gian thực&#10;        // So sánh ID người dùng đã đăng nhập với ID người đăng comment từ API&#10;        const canDelete = LOGGED_IN_USER_ID !== null &amp;&amp; Number(LOGGED_IN_USER_ID) === Number(comment.userId);&#10;&#10;        let html = '';&#10;        html += '&lt;div class=&quot;comment-item&quot;&gt;';&#10;        html += '    &lt;div class=&quot;comment-header&quot;&gt;';&#10;        html += '        &lt;div&gt;';&#10;        html += '            &lt;span class=&quot;comment-author&quot;&gt;' + userName + '&lt;/span&gt;';&#10;        html += '        &lt;/div&gt;';&#10;        html += '        &lt;div class=&quot;comment-time-actions&quot;&gt;';&#10;        html += '            &lt;span class=&quot;comment-time&quot;&gt;' + timeAgo + '&lt;/span&gt;';&#10;        if (canDelete) {&#10;            html += '            &lt;button type=&quot;button&quot; class=&quot;comment-delete-btn&quot; onclick=&quot;deleteComment(' + comment.id + ')&quot;&gt;Xóa&lt;/button&gt;';&#10;        }&#10;        html += '        &lt;/div&gt;';&#10;        html += '    &lt;/div&gt;';&#10;        html += '    &lt;div class=&quot;comment-content&quot;&gt;';&#10;        html += '        ' + content;&#10;        html += '    &lt;/div&gt;';&#10;        html += '&lt;/div&gt;';&#10;        return html;&#10;    }&#10;&#10;    // Hàm tải danh sách comment&#10;    async function fetchComments(videoId) {&#10;        if (!videoId) return;&#10;        try {&#10;            const response = await fetch(COMMENT_API_URL + &quot;?videoid=&quot; + videoId);&#10;            const contentType = response.headers.get(&quot;content-type&quot;) || &quot;&quot;;&#10;            if (!response.ok) throw new Error(&quot;HTTP &quot; + response.status);&#10;            if (!contentType.includes(&quot;application/json&quot;)) {&#10;                const preview = (await response.text()).slice(0, 200);&#10;                throw new Error(&quot;Server không trả JSON: &quot; + preview);&#10;            }&#10;&#10;            const comments = await response.json();&#10;            const listContainer = document.getElementById('comments-list');&#10;            listContainer.innerHTML = '';&#10;&#10;            if (comments.length === 0) {&#10;                listContainer.innerHTML = '&lt;p class=&quot;text-center text-muted&quot;&gt;Chưa có bình luận nào.&lt;/p&gt;';&#10;            } else {&#10;                comments.forEach(comment =&gt; {&#10;                    // Chỉ hiển thị comment cấp 1 (parent_id = null)&#10;                    if (comment.parentCommentId == null) {&#10;                        listContainer.innerHTML += renderComment(comment);&#10;                    }&#10;                });&#10;            }&#10;            document.getElementById('comment-count').textContent = comments.length;&#10;        } catch (error) {&#10;            console.error(&quot;Lỗi khi tải bình luận:&quot;, error);&#10;            document.getElementById('comments-list').innerHTML =&#10;                '&lt;p class=&quot;text-center text-danger&quot;&gt;Không thể tải bình luận. Vui lòng thử lại sau.&lt;/p&gt;';&#10;        }&#10;    }&#10;&#10;    // Hàm xử lý việc gửi comment mới&#10;    async function postComment() {&#10;        if (!LOGGED_IN_USER_ID) {&#10;            alert(&quot;Vui lòng đăng nhập để bình luận.&quot;);&#10;            return;&#10;        }&#10;&#10;        const commentInput = document.getElementById('comment-input');&#10;        const content = commentInput.value.trim();&#10;        const videoUrlID = (new URLSearchParams(window.location.search)).get('id');&#10;&#10;        if (!content) {&#10;            alert(&quot;Vui lòng nhập nội dung bình luận.&quot;);&#10;            return;&#10;        }&#10;&#10;        const postButton = document.getElementById('post-comment-btn');&#10;        postButton.disabled = true;&#10;&#10;        // SỬ DỤNG ID USER THỰC TẾ TỪ API&#10;        const commentDataJson = JSON.stringify({&#10;            content: content,&#10;            video: { id: parseInt(videoUrlID) },&#10;            user: { id: LOGGED_IN_USER_ID }  // Dùng ID từ API&#10;        });&#10;&#10;        try {&#10;            const response = await fetch(COMMENT_API_URL, {&#10;                method: 'POST',&#10;                headers: {&#10;                    'Content-Type': 'application/json'&#10;                },&#10;                body: commentDataJson&#10;            });&#10;&#10;            if (!response.ok) {&#10;                const errorResult = await response.json().catch(() =&gt; ({ error: 'Lỗi không xác định.' }));&#10;                throw new Error(errorResult.error || &quot;Lỗi khi gửi bình luận.&quot;);&#10;            }&#10;&#10;            alert(&quot;Bình luận đã được gửi thành công!&quot;);&#10;            commentInput.value = '';&#10;&#10;            await fetchComments(videoUrlID);&#10;&#10;        } catch (error) {&#10;            console.error(&quot;Lỗi gửi bình luận:&quot;, error);&#10;            alert(&quot;Gửi bình luận thất bại: &quot; + error.message);&#10;        } finally {&#10;            postButton.disabled = false;&#10;        }&#10;    }&#10;&#10;    // ✅ PHƯƠNG THỨC MỚI: Xử lý xóa comment&#10;    async function deleteComment(commentId) {&#10;        if (!LOGGED_IN_USER_ID) {&#10;            alert('Vui lòng đăng nhập để xóa bình luận của bạn.');&#10;            return;&#10;        }&#10;        if (!confirm('Bạn có chắc chắn muốn xóa bình luận này?')) {&#10;            return;&#10;        }&#10;&#10;        const videoUrlID = (new URLSearchParams(window.location.search)).get('id');&#10;        try {&#10;            const response = await fetch(`${COMMENT_API_URL}?id=${commentId}`, { method: 'DELETE' });&#10;&#10;            if (response.status === 204) {&#10;                await fetchComments(videoUrlID);&#10;                return;&#10;            }&#10;&#10;            const result = await response.json().catch(() =&gt; ({ message: '', error: 'Lỗi không xác định.' }));&#10;&#10;            if (response.ok) {&#10;                alert(result.message || 'Bình luận đã được xóa thành công!');&#10;                await fetchComments(videoUrlID);&#10;            } else {&#10;                alert(result.error || 'Xóa bình luận thất bại.');&#10;            }&#10;        } catch (error) {&#10;            console.error('Lỗi khi xóa bình luận:', error);&#10;            alert('Không thể kết nối server để xóa bình luận.');&#10;        }&#10;    }&#10;&#10;&#10;    async function fetchAndPlayVideo() {&#10;        try {&#10;           const videoUrlID = (new URLSearchParams(window.location.search)).get('id');&#10;            if (!videoUrlID) return;&#10;&#10;            // Sử dụng nối chuỗi thuần&#10;            const response = await fetch(VIDEO_API_URL);&#10;            if (!response.ok) throw new Error(&quot;Lỗi kết nối API&quot;);&#10;            const videos = await response.json();&#10;&#10;            const targetVideo = videos.find(video =&gt; video.id == videoUrlID);&#10;            if (!targetVideo) {&#10;                console.error(&quot;Không tìm thấy video với ID:&quot;, videoUrlID);&#10;                return;&#10;            }&#10;&#10;            document.getElementById('video-title').textContent = targetVideo.title;&#10;            document.getElementById('video-date').textContent = targetVideo.createAt;&#10;            document.getElementById('video-description').textContent = targetVideo.desc;&#10;&#10;            // Cập nhật iframe src&#10;            iframe.src = &quot;https://www.youtube.com/embed/&quot; + getYouTubeId(targetVideo.url);&#10;&#10;            // THÊM: Gọi hàm tải bình luận sau khi có video ID&#10;            await fetchComments(videoUrlID);&#10;        } catch (error) {&#10;            console.error(&quot;Lỗi khi tải dữ liệu video:&quot;, error);&#10;        }&#10;    }&#10;&#10;    // Khởi tạo&#10;    document.addEventListener('DOMContentLoaded', async () =&gt; {&#10;        // Tải thông tin người dùng trước để có tên hiển thị cho comment input&#10;        await fetchUserInfo();&#10;        // Sau đó tải video và bình luận&#10;        await fetchAndPlayVideo();&#10;    });&#10;&#10;    // Lắng nghe sự kiện Gửi bình luận&#10;    const postButton = document.getElementById('post-comment-btn');&#10;    if (postButton) {&#10;        postButton.addEventListener('click', postComment);&#10;    }&#10;&#10;    &lt;/script&gt;&#10;&lt;/body&gt;&#10;&lt;/html&gt;" />
              <option name="updatedContent" value="&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;&#10;&lt;!DOCTYPE html&gt;&#10;&lt;html lang=&quot;vi&quot;&gt;&#10;&lt;head&gt;&#10;    &lt;meta charset=&quot;UTF-8&quot;&gt;&#10;    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;&#10;    &lt;title&gt;Xem phim - RoPhim&lt;/title&gt;&#10;    &lt;link href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;&#10;    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css&quot;&gt;&#10;    &lt;style&gt;&#10;        :root {&#10;            --primary-color: #e50914;&#10;            --dark-color: #141414;&#10;            --light-color: #f4f4f4;&#10;            --secondary-color: #2c2c2c;&#10;        }&#10;&#10;        body {&#10;            background-color: #191b24;&#10;            color: var(--light-color);&#10;            font-family: 'Helvetica Neue', Arial, sans-serif;&#10;        }&#10;&#10;        .watch-container {&#10;            max-width: 1200px;&#10;            margin: 4rem auto;&#10;            padding: 0 15px;&#10;        }&#10;&#10;        .video-section {&#10;            background-color: var(--secondary-color);&#10;            border-radius: 10px;&#10;            padding: 1.5rem;&#10;            margin-bottom: 2rem;&#10;        }&#10;&#10;        .video-player {&#10;            /* Giữ nguyên chiều rộng và chiều cao để iframe lấp đầy */&#10;            width: 100%;&#10;            height: 500px;&#10;            background-color: #000;&#10;            border-radius: 8px;&#10;            margin-bottom: 1rem;&#10;            position: relative;&#10;            overflow: hidden;&#10;        }&#10;&#10;        /* Đảm bảo iframe lấp đầy hoàn toàn div chứa nó */&#10;        .video-player iframe {&#10;            width: 100%;&#10;            height: 100%;&#10;            border: none;&#10;        }&#10;&#10;        /* Loại bỏ CSS cho placeholder vì ta chèn iframe tĩnh */&#10;        .video-placeholder {&#10;            display: none;&#10;            /* Ẩn placeholder */&#10;        }&#10;&#10;        .video-info {&#10;            background-color: var(--secondary-color);&#10;            border-radius: 10px;&#10;            padding: 1.5rem;&#10;            margin-bottom: 2rem;&#10;        }&#10;&#10;        .video-title {&#10;            font-size: 1.5rem;&#10;            margin-bottom: 1rem;&#10;            color: var(--light-color);&#10;        }&#10;&#10;        .video-meta {&#10;            display: flex;&#10;            gap: 20px;&#10;            margin-bottom: 1rem;&#10;            color: #aaa;&#10;            font-size: 0.9rem;&#10;        }&#10;&#10;        .video-description {&#10;            line-height: 1.6;&#10;            color: #ccc;&#10;            margin-top: 1rem;&#10;        }&#10;&#10;        .section-title {&#10;            border-left: 4px solid var(--primary-color);&#10;            padding-left: 10px;&#10;            margin-bottom: 1.5rem;&#10;            font-weight: bold;&#10;        }&#10;&#10;        .comment-section {&#10;            background-color: var(--secondary-color);&#10;            border-radius: 10px;&#10;            padding: 1.5rem;&#10;        }&#10;&#10;        /* Style cho Form Gửi Comment */&#10;        .comment-form .btn-primary {&#10;            background-color: var(--primary-color);&#10;            border-color: var(--primary-color);&#10;            transition: background-color 0.3s;&#10;        }&#10;        .comment-form .btn-primary:hover {&#10;            background-color: #ff3333;&#10;            border-color: #ff3333;&#10;        }&#10;&#10;        .comment-item {&#10;            background-color: #333;&#10;            border-radius: 10px;&#10;            padding: 1rem;&#10;            margin-bottom: 1rem;&#10;        }&#10;&#10;        .comment-header {&#10;            display: flex;&#10;            justify-content: space-between;&#10;            margin-bottom: 0.5rem;&#10;            gap: 1rem;&#10;        }&#10;&#10;        .comment-time-actions {&#10;            display: flex;&#10;            align-items: center;&#10;            gap: 0.75rem;&#10;        }&#10;&#10;        .comment-delete-btn {&#10;            background: transparent;&#10;            border: none;&#10;            color: #ff6b6b;&#10;            cursor: pointer;&#10;            font-size: 0.85rem;&#10;            padding: 0.2rem 0.4rem;&#10;            transition: color 0.2s;&#10;        }&#10;&#10;        .comment-delete-btn:hover {&#10;            color: #ff8a8a;&#10;            text-decoration: underline;&#10;        }&#10;&#10;        .comment-author {&#10;            color: var(--primary-color);&#10;            font-weight: bold;&#10;        }&#10;&#10;        .comment-time {&#10;            color: #aaa;&#10;            font-size: 0.9rem;&#10;        }&#10;&#10;        .comment-content {&#10;            line-height: 1.5;&#10;        }&#10;&#10;        .load-more {&#10;            text-align: center;&#10;            margin-top: 1rem;&#10;        }&#10;&#10;        .btn-load-more {&#10;            background-color: #333;&#10;            color: var(--light-color);&#10;            border: none;&#10;            padding: 10px 20px;&#10;            border-radius: 5px;&#10;            transition: all 0.3s;&#10;        }&#10;&#10;        .btn-load-more:hover {&#10;            background-color: var(--primary-color);&#10;        }&#10;&#10;        .login-prompt {&#10;            text-align: center;&#10;            padding: 2rem;&#10;            color: #aaa;&#10;        }&#10;&#10;        .login-prompt a {&#10;            color: var(--primary-color);&#10;            text-decoration: none;&#10;        }&#10;&#10;        .login-prompt a:hover {&#10;            text-decoration: underline;&#10;        }&#10;&#10;        @media (max-width: 768px) {&#10;            .video-player {&#10;                height: 300px;&#10;            }&#10;            .video-controls {&#10;                flex-direction: column;&#10;                gap: 10px;&#10;            }&#10;        }&#10;    &lt;/style&gt;&#10;&lt;/head&gt;&#10;&lt;body style=&quot;margin-top:100px;&quot;&gt;&#10;    &lt;%@ include file=&quot;../component/common/Header.jsp&quot;%&gt;&#10;&#10;    &lt;div class=&quot;watch-container&quot;&gt;&#10;        &lt;div class=&quot;video-section&quot;&gt;&#10;            &lt;div class=&quot;video-player&quot; id=&quot;video-container&quot;&gt;&#10;                &lt;iframe id=&quot;video-frame&quot;&#10;                    width=&quot;100%&quot;&#10;                    height=&quot;100%&quot;&#10;                    src=&quot;&quot;&#10;                    title=&quot;Video player&quot;&#10;                    frameborder=&quot;0&quot;&#10;                    allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot;&#10;                    allowfullscreen&gt;&#10;                &lt;/iframe&gt;&#10;            &lt;/div&gt;&#10;            &lt;div class=&quot;video-info&quot;&gt;&#10;                &lt;h1 class=&quot;video-title&quot; id=&quot;video-title&quot;&gt;title&lt;/h1&gt;&#10;                &lt;div class=&quot;video-meta&quot;&gt;&#10;                    &lt;span id=&quot;video-date&quot;&gt;loading...&lt;/span&gt;&#10;                &lt;/div&gt;&#10;                &lt;div class=&quot;video-description&quot; id=&quot;video-description&quot;&gt;&#10;                    description&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;&#10;            &lt;div class=&quot;comment-section&quot;&gt;&#10;                &lt;h3 class=&quot;section-title&quot;&gt;Bình luận (&lt;span id=&quot;comment-count&quot;&gt;0&lt;/span&gt;)&lt;/h3&gt;&#10;&#10;                &lt;div class=&quot;comment-form mb-4&quot; id=&quot;comment-form-section&quot; style=&quot;display: none;&quot;&gt;&#10;                    &lt;textarea class=&quot;form-control&quot; id=&quot;comment-input&quot; rows=&quot;3&quot; placeholder=&quot;Nhập bình luận của bạn...&quot; style=&quot;background-color: #444; color: #fff; border: 1px solid #555;&quot; required&gt;&lt;/textarea&gt;&#10;                    &lt;div class=&quot;d-flex justify-content-end mt-2&quot;&gt;&#10;                        &lt;button class=&quot;btn btn-primary&quot; id=&quot;post-comment-btn&quot;&gt;Gửi bình luận&lt;/button&gt;&#10;                    &lt;/div&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div class=&quot;login-prompt&quot; id=&quot;login-prompt-section&quot; style=&quot;display: none;&quot;&gt;&#10;                    &lt;a href=&quot;${pageContext.request.contextPath}/auth/login&quot;&gt;Đăng nhập để bình luận&lt;/a&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div id=&quot;comments-list&quot;&gt;&#10;                &lt;/div&gt;&#10;&#10;                &lt;div class=&quot;load-more&quot;&gt;&#10;                    &lt;button class=&quot;btn-load-more&quot;&gt;&#10;                        &lt;i class=&quot;bi bi-arrow-down me-2&quot;&gt;&lt;/i&gt;Tải thêm bình luận&#10;                    &lt;/button&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;    &lt;/div&gt;&#10;&#10;    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js&quot;&gt;&lt;/script&gt;&#10;    &lt;script&gt;&#10;    const VIDEO_API_URL = &quot;${pageContext.request.contextPath}/api/videos&quot;;&#10;    const COMMENT_API_URL = &quot;${pageContext.request.contextPath}/api/comment&quot;;&#10;    const USER_INFO_API_URL = &quot;${pageContext.request.contextPath}/api/userinfo&quot;;&#10;&#10;    console.log('API URLs initialized:');&#10;    console.log('VIDEO_API_URL:', VIDEO_API_URL);&#10;    console.log('COMMENT_API_URL:', COMMENT_API_URL);&#10;    console.log('USER_INFO_API_URL:', USER_INFO_API_URL);&#10;&#10;    const iframe = document.getElementById(&quot;video-frame&quot;);&#10;&#10;    let LOGGED_IN_USER_ID = null;&#10;    let LOGGED_IN_USER_DISPLAY_NAME = 'Anonymous';&#10;&#10;    // ✅ CẬP NHẬT: Hàm tải thông tin người dùng và hiển thị form comment&#10;    async function fetchUserInfo() {&#10;        try {&#10;            const response = await fetch(USER_INFO_API_URL);&#10;            if (!response.ok) {&#10;                // User chưa đăng nhập hoặc API lỗi&#10;                document.getElementById('login-prompt-section').style.display = 'block';&#10;                return;&#10;            }&#10;&#10;            const user = await response.json();&#10;&#10;            if (user.id) {&#10;                LOGGED_IN_USER_ID = user.id;&#10;            }&#10;&#10;            // ✅ CẬP NHẬT: Sử dụng username làm tên hiển thị&#10;            if (user.username) {&#10;                LOGGED_IN_USER_DISPLAY_NAME = user.username;&#10;            } else if (user.name) {&#10;                // Fallback nếu username không tồn tại&#10;                LOGGED_IN_USER_DISPLAY_NAME = user.name;&#10;            }&#10;&#10;            // Hiển thị form comment&#10;            document.getElementById('comment-form-section').style.display = 'block';&#10;            const commentInput = document.getElementById('comment-input');&#10;            if (commentInput) {&#10;                commentInput.placeholder = `Bình luận với tên ${LOGGED_IN_USER_DISPLAY_NAME}...`;&#10;            }&#10;&#10;        } catch (error) {&#10;            console.error(&quot;Lỗi khi tải dữ liệu người dùng:&quot;, error);&#10;            document.getElementById('login-prompt-section').style.display = 'block';&#10;        }&#10;    }&#10;&#10;    //lấy id của video&#10;    function getYouTubeId(url) {&#10;        if (!url) return null;&#10;        url = url.trim().replace(/&quot;/g, '');&#10;&#10;        const patterns = [&#10;            /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,&#10;            /youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/,&#10;            /youtu\.be\/([a-zA-Z0-9_-]{11})/,&#10;            /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,&#10;            /youtube\.com\/v\/([a-zA-Z0-9_-]{11})/&#10;        ];&#10;&#10;        for (let pattern of patterns) {&#10;            const match = url.match(pattern);&#10;            if (match &amp;&amp; match[1]) {&#10;                return match[1];&#10;            }&#10;        }&#10;        return null;&#10;    }&#10;&#10;    // ✅ CẬP NHẬT: Hàm render một comment (Sử dụng comment.userId)&#10;    function renderComment(comment) {&#10;        const userName = comment.userName || 'Anonymous';&#10;        const content = comment.content || 'Không có nội dung.';&#10;        const timeAgo = &quot;Vừa xong&quot;; // Cần logic tính thời gian thực&#10;        // So sánh ID người dùng đã đăng nhập với ID người đăng comment từ API&#10;        const canDelete = LOGGED_IN_USER_ID !== null &amp;&amp; Number(LOGGED_IN_USER_ID) === Number(comment.userId);&#10;&#10;        let html = '';&#10;        html += '&lt;div class=&quot;comment-item&quot;&gt;';&#10;        html += '    &lt;div class=&quot;comment-header&quot;&gt;';&#10;        html += '        &lt;div&gt;';&#10;        html += '            &lt;span class=&quot;comment-author&quot;&gt;' + userName + '&lt;/span&gt;';&#10;        html += '        &lt;/div&gt;';&#10;        html += '        &lt;div class=&quot;comment-time-actions&quot;&gt;';&#10;        html += '            &lt;span class=&quot;comment-time&quot;&gt;' + timeAgo + '&lt;/span&gt;';&#10;        if (canDelete) {&#10;            html += '            &lt;button type=&quot;button&quot; class=&quot;comment-delete-btn&quot; onclick=&quot;deleteComment(' + comment.id + ')&quot;&gt;Xóa&lt;/button&gt;';&#10;        }&#10;        html += '        &lt;/div&gt;';&#10;        html += '    &lt;/div&gt;';&#10;        html += '    &lt;div class=&quot;comment-content&quot;&gt;';&#10;        html += '        ' + content;&#10;        html += '    &lt;/div&gt;';&#10;        html += '&lt;/div&gt;';&#10;        return html;&#10;    }&#10;&#10;    // Hàm tải danh sách comment&#10;    async function fetchComments(videoId) {&#10;        if (!videoId) return;&#10;        try {&#10;            const response = await fetch(COMMENT_API_URL + &quot;?videoid=&quot; + videoId);&#10;            const contentType = response.headers.get(&quot;content-type&quot;) || &quot;&quot;;&#10;            if (!response.ok) throw new Error(&quot;HTTP &quot; + response.status);&#10;            if (!contentType.includes(&quot;application/json&quot;)) {&#10;                const preview = (await response.text()).slice(0, 200);&#10;                throw new Error(&quot;Server không trả JSON: &quot; + preview);&#10;            }&#10;&#10;            const comments = await response.json();&#10;            const listContainer = document.getElementById('comments-list');&#10;            listContainer.innerHTML = '';&#10;&#10;            if (comments.length === 0) {&#10;                listContainer.innerHTML = '&lt;p class=&quot;text-center text-muted&quot;&gt;Chưa có bình luận nào.&lt;/p&gt;';&#10;            } else {&#10;                comments.forEach(comment =&gt; {&#10;                    // Chỉ hiển thị comment cấp 1 (parent_id = null)&#10;                    if (comment.parentCommentId == null) {&#10;                        listContainer.innerHTML += renderComment(comment);&#10;                    }&#10;                });&#10;            }&#10;            document.getElementById('comment-count').textContent = comments.length;&#10;        } catch (error) {&#10;            console.error(&quot;Lỗi khi tải bình luận:&quot;, error);&#10;            document.getElementById('comments-list').innerHTML =&#10;                '&lt;p class=&quot;text-center text-danger&quot;&gt;Không thể tải bình luận. Vui lòng thử lại sau.&lt;/p&gt;';&#10;        }&#10;    }&#10;&#10;    // Hàm xử lý việc gửi comment mới&#10;    async function postComment() {&#10;        if (!LOGGED_IN_USER_ID) {&#10;            alert(&quot;Vui lòng đăng nhập để bình luận.&quot;);&#10;            return;&#10;        }&#10;&#10;        const commentInput = document.getElementById('comment-input');&#10;        const content = commentInput.value.trim();&#10;        const videoUrlID = (new URLSearchParams(window.location.search)).get('id');&#10;&#10;        if (!content) {&#10;            alert(&quot;Vui lòng nhập nội dung bình luận.&quot;);&#10;            return;&#10;        }&#10;&#10;        const postButton = document.getElementById('post-comment-btn');&#10;        postButton.disabled = true;&#10;&#10;        // SỬ DỤNG ID USER THỰC TẾ TỪ API&#10;        const commentDataJson = JSON.stringify({&#10;            content: content,&#10;            video: { id: parseInt(videoUrlID) },&#10;            user: { id: LOGGED_IN_USER_ID }  // Dùng ID từ API&#10;        });&#10;&#10;        try {&#10;            const response = await fetch(COMMENT_API_URL, {&#10;                method: 'POST',&#10;                headers: {&#10;                    'Content-Type': 'application/json'&#10;                },&#10;                body: commentDataJson&#10;            });&#10;&#10;            if (!response.ok) {&#10;                const errorResult = await response.json().catch(() =&gt; ({ error: 'Lỗi không xác định.' }));&#10;                throw new Error(errorResult.error || &quot;Lỗi khi gửi bình luận.&quot;);&#10;            }&#10;&#10;            alert(&quot;Bình luận đã được gửi thành công!&quot;);&#10;            commentInput.value = '';&#10;&#10;            await fetchComments(videoUrlID);&#10;&#10;        } catch (error) {&#10;            console.error(&quot;Lỗi gửi bình luận:&quot;, error);&#10;            alert(&quot;Gửi bình luận thất bại: &quot; + error.message);&#10;        } finally {&#10;            postButton.disabled = false;&#10;        }&#10;    }&#10;&#10;    // ✅ PHƯƠNG THỨC MỚI: Xử lý xóa comment&#10;    async function deleteComment(commentId) {&#10;        if (!LOGGED_IN_USER_ID) {&#10;            alert('Vui lòng đăng nhập để xóa bình luận của bạn.');&#10;            return;&#10;        }&#10;        if (!confirm('Bạn có chắc chắn muốn xóa bình luận này?')) {&#10;            return;&#10;        }&#10;&#10;        const videoUrlID = (new URLSearchParams(window.location.search)).get('id');&#10;        const deleteUrl = COMMENT_API_URL + '?id=' + commentId;&#10;        console.log('Deleting comment, URL:', deleteUrl);&#10;        &#10;        try {&#10;            const response = await fetch(deleteUrl, { method: 'DELETE' });&#10;&#10;            if (response.status === 204) {&#10;                await fetchComments(videoUrlID);&#10;                return;&#10;            }&#10;&#10;            const result = await response.json().catch(() =&gt; ({ message: '', error: 'Lỗi không xác định.' }));&#10;&#10;            if (response.ok) {&#10;                alert(result.message || 'Bình luận đã được xóa thành công!');&#10;                await fetchComments(videoUrlID);&#10;            } else {&#10;                alert(result.error || 'Xóa bình luận thất bại.');&#10;            }&#10;        } catch (error) {&#10;            console.error('Lỗi khi xóa bình luận:', error);&#10;            alert('Không thể kết nối server để xóa bình luận.');&#10;        }&#10;    }&#10;&#10;&#10;    async function fetchAndPlayVideo() {&#10;        try {&#10;           const videoUrlID = (new URLSearchParams(window.location.search)).get('id');&#10;            if (!videoUrlID) return;&#10;&#10;            // Sử dụng nối chuỗi thuần&#10;            const response = await fetch(VIDEO_API_URL);&#10;            if (!response.ok) throw new Error(&quot;Lỗi kết nối API&quot;);&#10;            const videos = await response.json();&#10;&#10;            const targetVideo = videos.find(video =&gt; video.id == videoUrlID);&#10;            if (!targetVideo) {&#10;                console.error(&quot;Không tìm thấy video với ID:&quot;, videoUrlID);&#10;                return;&#10;            }&#10;&#10;            document.getElementById('video-title').textContent = targetVideo.title;&#10;            document.getElementById('video-date').textContent = targetVideo.createAt;&#10;            document.getElementById('video-description').textContent = targetVideo.desc;&#10;&#10;            // Cập nhật iframe src&#10;            iframe.src = &quot;https://www.youtube.com/embed/&quot; + getYouTubeId(targetVideo.url);&#10;&#10;            // THÊM: Gọi hàm tải bình luận sau khi có video ID&#10;            await fetchComments(videoUrlID);&#10;        } catch (error) {&#10;            console.error(&quot;Lỗi khi tải dữ liệu video:&quot;, error);&#10;        }&#10;    }&#10;&#10;    // Khởi tạo&#10;    document.addEventListener('DOMContentLoaded', async () =&gt; {&#10;        // Tải thông tin người dùng trước để có tên hiển thị cho comment input&#10;        await fetchUserInfo();&#10;        // Sau đó tải video và bình luận&#10;        await fetchAndPlayVideo();&#10;    });&#10;&#10;    // Lắng nghe sự kiện Gửi bình luận&#10;    const postButton = document.getElementById('post-comment-btn');&#10;    if (postButton) {&#10;        postButton.addEventListener('click', postComment);&#10;    }&#10;&#10;    &lt;/script&gt;&#10;&lt;/body&gt;&#10;&lt;/html&gt;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>